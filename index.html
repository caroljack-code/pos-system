<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pimut Traders POS</title>
    <!-- Modern Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css?v=1.8">
</head>
<body>
    <div class="app-container">
        <!-- Sidebar Navigation -->
        <nav class="sidebar">
            <div class="logo">
                <img id="app-logo" src="/image/round logo.png" alt="Pimut Traders" style="width:40px;height:40px;border-radius:50%;object-fit:cover;display:inline-block;cursor:pointer;" onclick="uploadLogoClick()" onerror="this.style.display='none'; this.parentElement.querySelector('.fallback-logo').style.display='inline-flex';">
                <i class="fa-solid fa-shop fallback-logo" style="display:none;cursor:pointer;" onclick="uploadLogoClick()"></i>
                <span>Pimut Traders</span>
            </div>
            <ul class="nav-links">
                <li id="nav-pos" class="active" onclick="switchTab('pos')">
                    <i class="fa-solid fa-cash-register"></i> POS
                </li>
                <li id="nav-reports" onclick="switchTab('reports')">
                    <i class="fa-solid fa-chart-line"></i> Reports
                </li>
                <li id="nav-backups" onclick="switchTab('backups')">
                    <i class="fa-solid fa-database"></i> Backups
                </li>
                <li id="nav-inventory" onclick="switchTab('inventory')">
                    <i class="fa-solid fa-boxes-stacked"></i> Inventory
                </li>
                <li id="nav-users" onclick="switchTab('users')">
                    <i class="fa-solid fa-users"></i> Users
                </li>
                <li id="nav-reset" onclick="resetApp()" style="margin-top: auto; color: #ef4444; border-top: 1px solid #e2e8f0;">
                    <i class="fa-solid fa-rotate-right"></i> Reset App
                </li>
            </ul>
        </nav>

        <!-- Main Content Area -->
        <main class="main-content">
            <!-- POS View -->
            <div id="pos-view" class="view-section active">
                <header class="top-bar">
                    <h2>New Sale</h2>
                    <div class="user-profile">
                        <span id="user-display-name">Cashier</span>
                        <button onclick="logout()" class="secondary-btn" style="padding: 0.4rem 0.8rem; font-size: 0.85rem; border-radius: 6px; display: flex; align-items: center; gap: 0.4rem;">
                            <i class="fa-solid fa-right-from-bracket"></i> Logout
                        </button>
                        <button onclick="setApiBase()" class="secondary-btn" style="padding: 0.4rem 0.8rem; font-size: 0.85rem; border-radius: 6px; display: flex; align-items: center; gap: 0.4rem;">
                            <i class="fa-solid fa-server"></i> Server
                        </button>
                        <span id="api-base-indicator" style="margin-left:0.5rem;font-size:0.8rem;color:#64748b;"></span>
                        <div class="avatar"><i class="fa-solid fa-user"></i></div>
                    </div>
                </header>
                
                <div class="pos-layout">
                    <div class="products-section">
                        <div class="search-bar">
                            <i class="fa-solid fa-search"></i>
                            <input type="text" id="product-search" placeholder="Search products...">
                        </div>
                        <div class="search-bar">
                            <i class="fa-solid fa-barcode"></i>
                            <input type="text" id="barcode-input" placeholder="Scan barcode..." autocomplete="off">
                        </div>
                        <div id="product-admin-panel" style="display:none; background-color: var(--surface-color); border: 1px solid var(--border-color); border-radius: var(--radius-md); padding: 1rem; margin-bottom: 1rem;">
                            <div style="display:flex; justify-content: space-between; align-items:center; margin-bottom:0.75rem;">
                                <strong>Add Product</strong>
                                <button onclick="createProduct()" class="primary-btn" style="padding:0.5rem 1rem;">Save</button>
                            </div>
                            <div style="display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap:0.75rem;">
                                <input id="admin-prod-name" type="text" placeholder="Name" style="padding:0.6rem; border:1px solid var(--border-color); border-radius:8px;">
                                <input id="admin-prod-category" type="text" placeholder="Category" style="padding:0.6rem; border:1px solid var(--border-color); border-radius:8px;">
                                <input id="admin-prod-price" type="number" step="0.01" placeholder="Price" style="padding:0.6rem; border:1px solid var(--border-color); border-radius:8px;">
                                <input id="admin-prod-stock" type="number" placeholder="Stock" style="padding:0.6rem; border:1px solid var(--border-color); border-radius:8px;">
                                <input id="admin-prod-minprice" type="number" step="0.01" placeholder="Min Price (optional)" style="padding:0.6rem; border:1px solid var(--border-color); border-radius:8px;">
                                <input id="admin-prod-barcode" type="text" placeholder="Barcode (optional)" style="padding:0.6rem; border:1px solid var(--border-color); border-radius:8px;">
                                <input id="admin-prod-image-file" type="file" accept="image/*" style="padding:0.4rem; border:1px solid var(--border-color); border-radius:8px;">
                            </div>
                            <p id="admin-prod-error" style="color: var(--danger-color); display:none; margin-top:0.5rem;"></p>
                        </div>
                        <div id="low-stock-alerts" class="low-stock-alerts"></div>
                        <div id="products-list" class="products-grid">
                            <!-- Products will be loaded here -->
                        </div>
                    </div>
                    
                    <div class="cart-section">
                        <div class="cart-header">
                            <h3>Current Order</h3>
                            <button class="clear-cart" onclick="clearCart()"><i class="fa-solid fa-trash"></i></button>
                        </div>
                        <div id="cart-items" class="cart-items">
                            <p class="empty-cart-msg">No items added</p>
                        </div>
                        <div class="cart-summary">
                            <!-- Payment Method Section -->
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary); font-size: 0.9rem;">Payment Method</label>
                                <div class="payment-buttons-grid">
                                    <button onclick="selectPayment('cash')" class="pay-btn active" data-method="cash"><i class="fa-solid fa-money-bill"></i> Cash</button>
                                    <button onclick="selectPayment('mpesa')" class="pay-btn" data-method="mpesa"><i class="fa-solid fa-mobile-screen"></i> M-Pesa</button>
                                    <button onclick="selectPayment('bank')" class="pay-btn" data-method="bank"><i class="fa-solid fa-building-columns"></i> Bank</button>
                                    <button onclick="selectPayment('card')" class="pay-btn" data-method="card"><i class="fa-solid fa-credit-card"></i> Card</button>
                                    <button onclick="selectPayment('cheque')" class="pay-btn" data-method="cheque"><i class="fa-solid fa-money-check"></i> Cheque</button>
                                </div>
                                <input type="hidden" id="payment-method" value="cash">
                            </div>
                            <div class="summary-row" id="payment-ref-row" style="display:none;">
                                <span>Reference</span>
                                <span>
                                    <input id="payment-ref" type="text" placeholder="Transaction Ref" style="padding:0.5rem;border:1px solid var(--border-color);border-radius:8px;width:180px;">
                                </span>
                            </div>
                            <div class="summary-row" id="bank-select-row" style="display:none;">
                                <span>Bank</span>
                                <span>
                                    <select id="bank-select" style="padding:0.5rem;border:1px solid var(--border-color);border-radius:8px;width:180px;">
                                        <option value="">Select bank</option>
                                    </select>
                                </span>
                            </div>
                            <div class="summary-row" id="mpesa-phone-row" style="display:none;">
                                <span>M-Pesa Phone</span>
                                <span style="display:flex;gap:0.5rem;align-items:center;">
                                    <input id="mpesa-phone" type="tel" placeholder="2547XXXXXXXX" style="padding:0.5rem;border:1px solid var(--border-color);border-radius:8px;width:180px;">
                                    <button class="secondary-btn" style="padding:0.4rem 0.6rem;" onclick="promptMpesa()"><i class="fa-solid fa-bolt"></i> Prompt</button>
                                </span>
                            </div>
                            <div class="summary-row" id="mpesa-status-row" style="display:none;">
                                <span>Status</span>
                                <span id="mpesa-status" style="color:#64748b;">Waiting...</span>
                            </div>
                            <div class="summary-row">
                                <span>Subtotal</span>
                                <span id="cart-subtotal">KES 0.00</span>
                            </div>
                            <div class="summary-row total">
                                <span>Total</span>
                                <span id="cart-total">KES 0.00</span>
                            </div>
                            <button id="checkout-btn" class="checkout-btn" disabled>
                                <span>Checkout</span>
                                <i class="fa-solid fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reports View -->
            <div id="reports-view" class="view-section" style="display: none;">
                <header class="top-bar">
                    <h2>Daily Sales Report</h2>
                </header>
                <div class="report-container">
                    <div style="display:flex;gap:1rem;align-items:center;margin-bottom:1rem;">
                        <div>
                            <label style="font-size:0.9rem;color:#64748b;">Start</label>
                            <input type="date" id="report-start" style="padding:0.5rem;border:1px solid #e2e8f0;border-radius:8px;">
                        </div>
                        <div>
                            <label style="font-size:0.9rem;color:#64748b;">End</label>
                            <input type="date" id="report-end" style="padding:0.5rem;border:1px solid #e2e8f0;border-radius:8px;">
                        </div>
                        <button onclick="refreshReports()" class="refresh-btn"><i class="fa-solid fa-sync"></i> Apply</button>
                        <button onclick="downloadSalesCSV()" class="refresh-btn"><i class="fa-solid fa-file-csv"></i> Export Sales CSV</button>
                        <button onclick="downloadProductsCSV()" class="refresh-btn"><i class="fa-solid fa-file-csv"></i> Export Products CSV</button>
                    </div>
                    <div class="report-card">
                        <h3>Sales History</h3>
                        <button onclick="fetchDailyReport()" class="refresh-btn"><i class="fa-solid fa-sync"></i> Refresh</button>
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Sales Count</th>
                                    <th>Subtotal</th>
                                    <th>VAT</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody id="daily-sales-body">
                                <!-- Report data here -->
                            </tbody>
                        </table>
                    </div>
                    <div class="report-card" style="margin-top:1rem;">
                        <h3>Sales Per Cashier</h3>
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>Cashier</th>
                                    <th>Sales Count</th>
                                    <th>Subtotal</th>
                                    <th>VAT</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody id="cashier-sales-body"></tbody>
                        </table>
                    </div>
                    <div class="report-card" style="margin-top:1rem;">
                        <h3>Totals by Payment Method</h3>
                        <div style="display:flex;gap:0.75rem;align-items:center;margin-bottom:0.5rem;">
                            <label style="font-size:0.9rem;color:#64748b;">Period</label>
                            <select id="pm-period" style="padding:0.5rem;border:1px solid var(--border-color);border-radius:8px;">
                                <option value="weekly">Weekly</option>
                                <option value="monthly" selected>Monthly</option>
                                <option value="annual">Annual</option>
                            </select>
                            <button onclick="fetchPaymentMethodReport()" class="refresh-btn"><i class="fa-solid fa-sync"></i> Refresh</button>
                        </div>
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>Period</th>
                                    <th>Payment Method</th>
                                    <th>Sales Count</th>
                                    <th>Subtotal</th>
                                    <th>VAT</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody id="pm-report-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Inventory View -->
            <div id="inventory-view" class="view-section" style="display:none;">
                <header class="top-bar">
                    <h2>Inventory Management</h2>
                </header>
                <div class="report-container">
                    <div style="display:flex;gap:1rem;align-items:center;margin-bottom:1rem;">
                        <div class="search-bar" style="flex:1;max-width:420px;">
                            <i class="fa-solid fa-barcode"></i>
                            <input type="text" id="inventory-barcode" placeholder="Scan or enter product barcode..." autocomplete="off">
                        </div>
                        <button onclick="inventoryBarcodeLookup()" class="refresh-btn"><i class="fa-solid fa-search"></i> Find</button>
                        <span id="inventory-barcode-status" style="color:#64748b;"></span>
                    </div>
                    <div class="report-card">
                        <h3>Products</h3>
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Category</th>
                                    <th>Price</th>
                                    <th>Min Price</th>
                                    <th>Stock</th>
                                    <th>Low Stock Threshold</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="inventory-body">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Backups View -->
            <div id="backups-view" class="view-section" style="display:none;">
                <header class="top-bar">
                    <h2>Backups & Export</h2>
                </header>
                <div class="report-container">
                    <div style="display:flex;gap:1rem;align-items:center;margin-bottom:1rem;">
                        <div>
                            <label style="font-size:0.9rem;color:#64748b;">Start</label>
                            <input type="date" id="backup-start" style="padding:0.5rem;border:1px solid #e2e8f0;border-radius:8px;">
                        </div>
                        <div>
                            <label style="font-size:0.9rem;color:#64748b;">End</label>
                            <input type="date" id="backup-end" style="padding:0.5rem;border:1px solid #e2e8f0;border-radius:8px;">
                        </div>
                        <button onclick="downloadSalesCSV(true)" class="refresh-btn"><i class="fa-solid fa-file-csv"></i> Export Sales CSV</button>
                        <button onclick="downloadProductsCSV(true)" class="refresh-btn"><i class="fa-solid fa-file-csv"></i> Export Products CSV</button>
                    </div>
                    <div class="report-card">
                        <p>Exports are restricted to Admin and Super Admin.</p>
                    </div>
                </div>
            </div>
            
            <!-- Users View -->
            <div id="users-view" class="view-section" style="display:none;">
                <header class="top-bar">
                    <h2>User Management</h2>
                </header>
                <div class="report-container">
                    <div class="report-card">
                        <h3>Add Cashier</h3>
                        <div style="display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:0.75rem;margin-top:0.5rem;">
                            <input id="new-user-username" type="text" placeholder="Username" style="padding:0.6rem;border:1px solid var(--border-color);border-radius:8px;">
                            <input id="new-user-password" type="password" placeholder="Password" style="padding:0.6rem;border:1px solid var(--border-color);border-radius:8px;">
                        </div>
                        <div style="margin-top:0.75rem;">
                            <button onclick="createUser()" class="primary-btn"><i class="fa-solid fa-user-plus"></i> Add Cashier</button>
                            <p id="new-user-error" style="color: var(--danger-color); display:none; margin-top:0.5rem;"></p>
                        </div>
                    </div>
                    <div class="report-card" style="margin-top:1rem;">
                        <h3>Cashiers</h3>
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Username</th>
                                    <th>Role</th>
                                </tr>
                            </thead>
                            <tbody id="users-body"></tbody>
                        </table>
                        <button onclick="fetchUsers()" class="refresh-btn" style="margin-top:0.75rem;"><i class="fa-solid fa-sync"></i> Refresh</button>
                    </div>
                    <div class="report-card" style="margin-top:1rem;">
                        <h3>Change My Password</h3>
                        <div style="display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:0.75rem;margin-top:0.5rem;">
                            <input id="my-old-password" type="password" placeholder="Current Password" style="padding:0.6rem;border:1px solid var(--border-color);border-radius:8px;">
                            <input id="my-new-password" type="password" placeholder="New Password" style="padding:0.6rem;border:1px solid var(--border-color);border-radius:8px;">
                        </div>
                        <div style="margin-top:0.75rem;">
                            <button onclick="changeMyPassword()" class="secondary-btn"><i class="fa-solid fa-key"></i> Update Password</button>
                            <p id="my-password-error" style="color: var(--danger-color); display:none; margin-top:0.5rem;"></p>
                        </div>
                    </div>
                    <div class="report-card" style="margin-top:1rem;">
                        <h3>Manage Banks</h3>
                        <div style="display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:0.75rem;margin-top:0.5rem;">
                            <input id="new-bank-name" type="text" placeholder="Bank name" style="padding:0.6rem;border:1px solid var(--border-color);border-radius:8px;">
                            <button onclick="addBank()" class="primary-btn"><i class="fa-solid fa-plus"></i> Add Bank</button>
                        </div>
                        <table class="report-table" style="margin-top:0.75rem;">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                </tr>
                            </thead>
                            <tbody id="banks-body"></tbody>
                        </table>
                        <button onclick="fetchBanksAdmin()" class="refresh-btn" style="margin-top:0.75rem;"><i class="fa-solid fa-sync"></i> Refresh</button>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Login Modal -->
    <div id="login-modal" class="modal" style="display: block;">
        <div class="modal-content" style="max-width: 400px; text-align: center;">
            <div class="receipt-header">
                <i class="fa-solid fa-user-lock" style="font-size: 3rem; color: var(--primary-color); margin-bottom: 1rem;"></i>
                <h2>Login Required</h2>
                <p>Please sign in to continue</p>
            </div>
            <div style="margin-bottom: 1rem; text-align: left;">
                <label style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary);">Username</label>
                <input type="text" id="login-username" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: var(--radius-md);" placeholder="Enter username">
            </div>
            <div style="margin-bottom: 2rem; text-align: left;">
                <label style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary);">Password</label>
                <input type="password" id="login-password" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: var(--radius-md);" placeholder="Enter password">
            </div>
            <p id="login-error" style="color: var(--danger-color); display: none; margin-bottom: 1rem;"></p>
            <div style="display:flex;gap:0.5rem;justify-content:center;margin-bottom:0.5rem;">
                <button onclick="setApiBase()" class="secondary-btn" style="padding: 0.4rem 0.8rem; font-size: 0.85rem; border-radius: 6px; display: inline-flex; align-items: center; gap: 0.4rem;">
                    <i class="fa-solid fa-server"></i> Server
                </button>
                <button onclick="resetApp()" class="secondary-btn" style="padding: 0.4rem 0.8rem; font-size: 0.85rem; border-radius: 6px; display: inline-flex; align-items: center; gap: 0.4rem;">
                    <i class="fa-solid fa-rotate-right"></i> Reset
                </button>
                <span id="login-api-indicator" style="font-size:0.8rem;color:#64748b;align-self:center;"></span>
            </div>
            <button onclick="login()" class="primary-btn" style="width: 100%;">Sign In</button>
            <div style="margin-top: 1rem; font-size: 0.8rem; color: var(--text-secondary);">
                Default: admin / admin123 (Super Admin)<br>
                cashier / cashier123 (Cashier)
            </div>
        </div>
    </div>

    <!-- Receipt Modal -->
    <div id="receipt-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <div class="receipt-header">
                <i class="fa-solid fa-check-circle success-icon"></i>
                <h2>Payment Successful</h2>
                <p>Transaction Complete</p>
            </div>
            <div id="receipt-details"></div>
            <div class="modal-footer">
                <button onclick="closeReceipt()" class="secondary-btn">Close</button>
                <button onclick="window.print()" class="primary-btn"><i class="fa-solid fa-print"></i> Print Receipt</button>
            </div>
        </div>
    </div>

    <script src="app.js?v=2.6"></script>
</body>
</html>
